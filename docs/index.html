<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes">
  <meta property="og:type" content="website">
  <meta property="og:title" content="영화1+1 알림">
  <meta property="og:description" content="롯데시네마, CGV, 메가박스 1+1 얼리버드 알림">
  <meta property="og:image" content="https://cinemabot.duckdns.org/logo_big.jpeg">
  <meta property="og:url" content="https://cinemabot.duckdns.org/">
  <link rel="favicon" href="favicon.ico">
  <title>영화1+1 알림</title>
  <style>
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0 8px;
    padding: 0;
  }
  h2, p {
    margin: 1px;
  }
  ul {
    margin: 0;
    padding: 0;
  }
  .container {
    min-width: 300px;
    max-width: 500px;
    margin: 0 auto;
  }
  .container h1 {
    margin: 0 auto;
    padding: 10px 0;
  }
  .header {
    position: fixed;
    top: 0;
    right: 0;
    left: 0;
    text-align: center;
    background-color: white;
    z-index: 1;
  }
  .header .inner {
    margin: 0 auto;
    padding: 0 5px 5px;
    min-width: 300px;
    max-width: 500px;
    text-align: left;
  }
  #chats {
    margin-top: 150px;
    margin-bottom: 140px;
  }
  .chat {
    position:relative;
    margin: 5px 0;
  }
  .logo {
    float: left;
    width: 36px;
    border-radius: 18px;
  }
  .bubble_icon {
     display: inline-block;
     width: 10px;
     height: 10px;
     background-color: white;
     position: absolute;
     top: 10px;
     left: 40px;
     border-left: 1px solid #d7e3ec;
     border-bottom: 1px solid #d7e3ec;
     transform: rotate(45deg);
  }
  .info {
    padding: 5px;
    margin-left: 45px;
    border: 1px solid #d7e3ec;
    border-radius: 0 10px 10px 10px;
  }
  .date {
    font-size: 0.8rem;
    text-align: right;
    margin-top: 10px;
  }
  .title {
    font-size: 1.2rem;
  }
  .range {
    font-size: 0.8rem;
  }
  .ellipsis {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .ad {
    width: 100%;
    height: 130px;
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #80808080;
    text-align: center;
  }
  </style>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <!--<script data-ad-client="ca-pub-8598336719433043" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    var response
    function start() {
      // 2. Initialize the JavaScript client library.
      gapi.client.init({
        'apiKey': 'AIzaSyCTNqqcP0PcpbyNkyvUxgrtRvnqXqB7U4U',
      }).then(function() {
        return gapi.client.request({
          'path': 'https://sheets.googleapis.com/v4/spreadsheets/1PXoXNt12WjW-2nyYh1lzZu35Vm9lucagRon9N9dJKJU/values/시트1',
        })
      }).then(function(res) {
        console.log(response = res.result)
      }, function(reason) {
        console.log('Error: ' + reason.result.error.message)
      })
    }
    // 1. Load the JavaScript client library.
    gapi.load('client', start)
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155230507-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-155230507-1');
  </script>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="inner">
      <h1>영화1+1 알림 채널</h1>
      <p>
        환영합니다. 해당 채널을 구독하고<br>
        <strong>롯데시네마, CGV, 메가박스</strong>의 1+1 알림을 제공받으세요.
      </p>
      텔레그램 채널: <a href="https://t.me/cinema1p1">https://t.me/cinema1p1</a>
    </div>
  </div>
  <ul id="chats">
    <li class="chat">
      <img class="logo" src="/logo.jpeg" alt="">
      <span class="bubble_icon"></span>
      <div class="info">
        잠시만 기다려주세요.
      </div>
    </li>
  </ul>
  <div class="ad">
    <script src="https://ads-partners.coupang.com/g.js"></script>
    <script>new PartnersCoupang.G({ id:124899, width: '100%' });</script>
  </div>
</div>
<script>
String.prototype.format = function() {
  var args = arguments;
  return this.replace(/{(\d+)(:[\wㄱ-힣]+)?}/g, function(match, number) {
    return typeof args[ number ] !== undefined ? args[ number ] : match;
  });
};
function getQuery() {
  var queries = {}
    location.search.substr(1)
      .split('&')
      .forEach(function (param) {
        var data = param.split('=')
        queries[data[0]] = decodeURIComponent(data[1])
      })
    return queries
}
function getHtml() {
  if (!window.$html) window.$html = document.getElementsByTagName('html')[0]
  return window.$html
}
function getWrapper() {
  if (!window.$chats) window.$chats = document.getElementById('chats')
  return window.$chats
}
function setChat(googleSheet) {
  getWrapper().innerHTML = makeChatHtml(googleSheet)
  getHtml().scrollTo(0, 100000)
}
function setChats(googleSheets) {
  getWrapper().innerHTML = googleSheets
    .map(function(googleSheet) {
      return makeChatHtml(googleSheet)
    })
    .join('')
  getHtml().scrollTo(0, 100000)
}
function makeChatHtml(googleSheet) {
  var date = googleSheet[1],
      service = googleSheet[2],
      title = googleSheet[3],
      range = googleSheet[4],
      price = googleSheet[5],
      url = decodeURIComponent(googleSheet[6]),
      formattedDate = date.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/g, function($0,$1,$2,$3,$4,$5,$6) {
        return '{0:YYYY}.{1:MM}.{2:DD} {3:HH}:{4:mm}:{5:ss}'.format($1,$2,$3,$4,$5,$6)
      })
  return [
    '<li id="{0:id}" class="chat">'.format(date),
      '<img class="logo" src="/logo.jpeg" alt="">',
      '<span class="bubble_icon"></span>',
      '<div class="info">',
        '<p class="service">{0:service}</p>'.format(service),
        '<h2 class="title">{0:title}</h2>'.format(title),
        '<p class="range">{0:range}</p>'.format(range),
        price ? '<p class="price">금액: {0:price}</p>'.format(price) : '',
        '<a class="ellipsis" href="{0:url}" target="_blank">{0:url}</a>'.format(url),
        '<p class="date">{0:date}</p>'.format(formattedDate),
      '</div>',
    '</li>',
    ].join('')
}

var queries = getQuery()

var i = setInterval(function() {
  if (!response) return
  clearInterval(i)
  var googleSheets = response.values
  if (!queries.key) return setChats(googleSheets.slice(Math.max(googleSheets.length - 40, 1)))
  var idx = googleSheets.findIndex(function(googleSheet) { return googleSheet[1] === queries.key })
  if (~idx) setChat(googleSheets[idx])
  else setChats(googleSheets.slice(Math.max(googleSheets.length - 10, 1)))
}, 200)

</script>

</body>
</html>
